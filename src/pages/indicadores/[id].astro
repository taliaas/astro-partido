---
import PoliticalService from "../../services/PoliticalService";
import ComputoService from "../../services/Computo";
import RootLayout from "../../layouts/RootLayout.astro";
import Editar from "../../components/Indicators/Editar.vue"
import {indicadores} from "../../lib/indicadoresKey";
import { getSession } from "auth-astro/server";
import MinutesService from "@/services/Minutes";

const {id} = Astro.params;
const session = (await getSession(Astro.request)) as any;

if (!id) {
    throw new Error("No id provided");
}

async function getActa(id: any, token: any) {
    const services = new MinutesService()
    try {
        return services.getMinute(id!, token)
    } catch (e) {
        console.error(e)
    }
}

async function getActaPolitica() {
    const services = new PoliticalService()
    try {
        return services.getMinutesByCore(acta.core.id, acta.fecha)
    } catch (e) {
        console.error(e)
    }
}

async function obtenerComputo() {
    const service = new ComputoService();
    try {
        return service.getComputo(id!, session);
    } catch (error) {
        console.log("error");
    }
}

const acta = await getActa(id,session)
const political = await getActaPolitica();
const ind = await obtenerComputo()
const map = new Map()
for (const {key} of indicadores) {
    map.set(key, 0)
    if (key in ind) map.set(key, ind[key])
}
---

<RootLayout>
    <Editar ind={Object.fromEntries(map.entries())} acta={acta} cp={political} client:load/>
</RootLayout>

---
