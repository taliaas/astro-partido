---
import MinutesService from "@/services/Minutes";
import { getSession } from "auth-astro/server";
import Editar from "../../components/Indicators/Editar.vue";
import RootLayout from "../../layouts/RootLayout.astro";
import ComputoService from "../../services/Computo";
import { indicators } from "../../utils/indicators";

const { id } = Astro.params;
const session = (await getSession(Astro.request)) as any;

if (!id) {
  throw new Error("No id provided");
}

async function getActa() {
  const services = new MinutesService();
  try {
    return services.getMinute(id!, session.jwt);
  } catch (e) {
    console.error(e);
  }
}

const acta = await getActa();

async function obtenerComputo() {
  const service = new ComputoService();
  try {
    return service.getCalcularComputo(id!, session);
  } catch (error) {
    console.log("error");
  }
}

const computo = await obtenerComputo();
const ind = computo.indicators;

const indList = [];
for (const key in indicators) {
  const indicator = ind.find((i: any) => i.key === key);
  indList.push({
    id: indicator?.id,
    key,
    value: indicator?.value ?? null,
    text: indicator?.text ?? "",
  });
}
---

<RootLayout>
  <Editar ind={indList} acta={acta} client:load />
</RootLayout>
