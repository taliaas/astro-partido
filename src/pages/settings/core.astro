---
import CoreManage from "@/components/settings/comites/ComiteSettings.vue";
import RootLayout from "@/layouts/RootLayout.astro";
import SettingsLayout from "@/layouts/SettingsLayout.astro";
import ComiteService from "@/services/ComiteService";
import CoreService from "@/services/CoreService";
import MilitantService from "@/services/MilitantService";
import { getSession } from "auth-astro/server";

const session = (await getSession(Astro.request)) as any;
const searchParams = Astro.url.searchParams;
const core = Number(searchParams.get("core") ?? 1);
const page = Number(searchParams.get("page") ?? 1);

async function getComites() {
  const service = new ComiteService();
  try {
    return service.getAllComite(session?.jwt);
  } catch (e) {
    console.error(e);
  }
}

async function getMilitants() {
  const service = new MilitantService();
  try {
    return service.getAll(core);
  } catch (e) {
    console.error(e);
  }
}

async function getCores() {
  const service = new CoreService();
  try {
    return service.getAllCoreByPage(page, session?.jwt);
  } catch (e) {
    console.error(e);
  }
}
const cores = await getCores();
const comites = await getComites();
const militants = await getMilitants();
---

<RootLayout>
  <SettingsLayout>
    <CoreManage
      comites={comites}
      cores={cores}
      militants={militants}
      client:load
    />
  </SettingsLayout>
</RootLayout>
