---
import CoreService from "@/services/CoreService";
import { getSession } from "auth-astro/server";
import Militantes from "@/components/settings/militantes/Militantes.vue";
import MilitantService from "@/services/MilitantService";
import RootLayout from "@/layouts/RootLayout.astro";
import SettingsLayout from "@/layouts/SettingsLayout.astro";

const session = (await getSession(Astro.request)) as any;
const searchParams = Astro.url.searchParams;
const core = searchParams.get("core") as any;
const page = Number(searchParams.get("page") ?? 1);
const name = searchParams.get("name") as any;
const org = searchParams.get("org") as any;
const email = searchParams.get("email") as any;
const status = searchParams.get("status") as any;

async function getMilitantes() {
  const service = new MilitantService();
  try {
    return service.getMilitantesByCore(name, org, email, status, core, page);
  } catch (e) {
    console.error(e);
  }
}

async function getCore() {
  const service = new CoreService();
  try {
    return await service.getAllCore(session.jwt);
  } catch (e) {
    console.error(e);
  }
}

const cores = await getCore();
const militantes = await getMilitantes();
---

<RootLayout>
  <SettingsLayout>
    <Militantes militants={militantes} cores={cores} client:load />
  </SettingsLayout>
</RootLayout>
