---
import UserManage from "@/components/settings/user/UserManage.vue";
import RootLayout from "@/layouts/RootLayout.astro";
import SettingsLayout from "@/layouts/SettingsLayout.astro";
import CoreService from "@/services/CoreService";
import MilitantService from "@/services/MilitantService";
import UserService from "@/services/UserService";
import { undefined } from "astro:schema";
import { getSession } from "auth-astro/server";

const session = (await getSession(Astro.request)) as any;
const searchParams = Astro.url.searchParams;
const page = Number(searchParams.get("page") ?? 1);
const order = searchParams.get("order") as any;
const name = searchParams.get("name") as any;
const role = searchParams.get("role") as any;
const email = searchParams.get("email") as any;
const core = searchParams.get("core") as any;
const status = searchParams.get("status") as any;

async function getAllUsers() {
  const service = new UserService();
  try {
    return service.getAllUser(
      page,
      session.jwt,
      name ?? undefined,
      email ?? undefined,
      core,
      order,
      status,
      role
    );
  } catch (e) {
    console.error(e);
  }
}

async function getCore() {
  const service = new CoreService();
  try {
    return await service.getAllCore(session.jwt);
  } catch (e) {
    console.error(e);
  }
}

async function getMilitants() {
  const service = new MilitantService();
  try {
    return await service.getAllByMilitants(session.jwt);
  } catch (e) {
    console.error(e);
  }
}

const users = await getAllUsers();
const cores = await getCore();
const militants = await getMilitants();
---

<RootLayout>
  <SettingsLayout>
    <UserManage militants={militants} users={users} cores={cores} client:load />
  </SettingsLayout>
</RootLayout>
