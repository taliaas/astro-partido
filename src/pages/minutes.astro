---
import { getSession } from "auth-astro/server";
import List from "../components/Acta/MinutesList.vue";
import RootLayout from "../layouts/RootLayout.astro";
import MinutesService from "../services/Minutes";
import CoreService from "@/services/CoreService";

const session = (await getSession(Astro.request)) as any;
const searchParams = Astro.url.searchParams;
const type = searchParams.get("type");
const page = searchParams.get("page");
const limit = searchParams.get("limit");
const order = searchParams.get("order") as any;
const name = searchParams.get("name");
const core = searchParams.get("core");
const status = searchParams.get("status") as any;
const fecha = searchParams.get("fecha") as any;

async function getActas() {
  try {
    const service = new MinutesService();
    if (!service) {
      throw new Error("Error al leer");
    }

    const acta = await service.getAllMinutes(
      type ?? undefined,
      page ? Number(page) : undefined,
      limit ?? "10",
      session,
      order,
      name ?? undefined,
      core ?? undefined,
      status,
      fecha
    );
    console.log(acta);
    return acta;
  } catch (error) {
    console.error("Error fetching actas:", error);
    throw error;
  }
}

async function getCores() {
  const service = new CoreService();
  try {
    return service.getAllCore(session.jwt);
  } catch (error) {
    return null;
  }
}

const cores = await getCores();
const actas = await getActas();
---

<RootLayout>
  <List
    actas={actas}
    type={type ?? "all"}
    page={Number(page || 1)}
    order={order}
    nucleos={cores}
    client:load
  />
</RootLayout>
